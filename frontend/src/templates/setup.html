{% extends "base.html" %}

{% block title %}Setup - Receipt Processing App{% endblock %}

{% block content %}
<div class="setup-container">
    <h2>Configure Google Sheets</h2>

    <div class="setup-instructions">
        <h3>How to find your Spreadsheet ID:</h3>
        <ol>
            <li>Open your Google Sheets spreadsheet</li>
            <li>Look at the URL: https://docs.google.com/spreadsheets/d/<strong>[SPREADSHEET_ID]</strong>/edit</li>
            <li>Copy the 44-character ID from the URL</li>
        </ol>
    </div>

    <form id="setup-form" class="setup-form">
        <div class="form-group">
            <label for="spreadsheet-id">Spreadsheet ID</label>
            <input
                type="text"
                id="spreadsheet-id"
                class="form-control"
                placeholder="1A2B3C4D5E6F7G8H9I0J1K2L3M4N5O6P7Q8R9S0T"
                pattern="[A-Za-z0-9_-]{44}"
                required
            />
            <small class="form-hint">Must be exactly 44 characters</small>
        </div>

        <div class="form-group">
            <label for="sheet-tab-name">Sheet Tab Name</label>
            <input
                type="text"
                id="sheet-tab-name"
                class="form-control"
                placeholder="Expenses 2025"
                maxlength="100"
                required
            />
            <small class="form-hint">The name of the specific tab/sheet within your spreadsheet</small>
        </div>

        <button type="submit" class="btn btn-primary">Save Preferences</button>
    </form>

    <div class="alert alert-success" id="success-message" style="display: none;"></div>
    <div class="alert alert-error" id="error-message" style="display: none;"></div>

    <div class="next-steps" id="next-steps" style="display: none;">
        <h3>Next Steps</h3>
        <p>Your spreadsheet is configured! Now configure your column mappings to start processing receipts.</p>
        <a href="/column-config" class="btn btn-primary">Configure Column Mappings</a>
    </div>

    <div class="current-config" id="current-config" style="display: none;">
        <h3>Current Configuration</h3>
        <div class="config-info">
            <p><strong>Spreadsheet ID:</strong> <span id="display-spreadsheet-id"></span></p>
            <p><strong>Sheet Tab:</strong> <span id="display-sheet-tab"></span></p>
            <p><strong>Column Mappings:</strong> <span id="display-column-mappings">Not configured</span></p>
        </div>
        <div style="margin-top: 1rem;">
            <a href="/column-config" class="btn btn-secondary">Update Column Mappings</a>
            <button id="disconnect-btn" class="btn btn-danger" style="margin-left: 1rem;">Disconnect Spreadsheet</button>
        </div>
    </div>
</div>

<script>
    document.getElementById('setup-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const spreadsheetId = document.getElementById('spreadsheet-id').value;
        const sheetTabName = document.getElementById('sheet-tab-name').value;

        try {
            const response = await fetch('/api/v1/auth/setup', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    spreadsheet_id: spreadsheetId,
                    sheet_tab_name: sheetTabName
                })
            });

            const data = await response.json();

            if (response.ok) {
                document.getElementById('success-message').textContent = data.message;
                document.getElementById('success-message').style.display = 'block';
                document.getElementById('next-steps').style.display = 'block';

                // Hide form after successful save
                document.getElementById('setup-form').style.display = 'none';
            } else {
                document.getElementById('error-message').textContent = data.message || 'Setup failed';
                document.getElementById('error-message').style.display = 'block';
            }
        } catch (error) {
            document.getElementById('error-message').textContent = 'Network error. Please try again.';
            document.getElementById('error-message').style.display = 'block';
        }
    });

    // Check current configuration status on page load
    async function checkCurrentConfig() {
        try {
            // Check auth status to get spreadsheet info
            const authResponse = await fetch('/api/v1/auth/status');
            const authData = await authResponse.json();

            if (authData.authenticated && authData.spreadsheet_configured) {
                // Show current config section
                document.getElementById('current-config').style.display = 'block';

                // Display spreadsheet info (if available)
                if (authData.spreadsheet_id) {
                    document.getElementById('display-spreadsheet-id').textContent =
                        authData.spreadsheet_id.substring(0, 20) + '...';
                }
                if (authData.sheet_tab_name) {
                    document.getElementById('display-sheet-tab').textContent = authData.sheet_tab_name;
                }

                // Check column mappings
                try {
                    const columnResponse = await fetch('/api/v1/column-config');
                    if (columnResponse.ok) {
                        const columnData = await columnResponse.json();
                        const mappings = `Date: ${columnData.date_column}, Description: ${columnData.description_column}, Price: ${columnData.price_column}`;
                        document.getElementById('display-column-mappings').textContent = mappings;
                    }
                } catch (err) {
                    // Column config not set yet - this is okay
                    console.log('Column mappings not configured yet');
                }
            }
        } catch (error) {
            console.error('Error checking configuration:', error);
        }
    }

    // Run on page load
    checkCurrentConfig();

    // Handle disconnect button
    document.getElementById('disconnect-btn')?.addEventListener('click', async () => {
        if (!confirm('Are you sure you want to disconnect? This will remove all spreadsheet configuration and column mappings.')) {
            return;
        }

        try {
            const response = await fetch('/api/v1/auth/disconnect', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });

            const data = await response.json();

            if (response.ok) {
                // Reload page to reset state
                window.location.reload();
            } else {
                document.getElementById('error-message').textContent = data.message || 'Disconnect failed';
                document.getElementById('error-message').style.display = 'block';
            }
        } catch (error) {
            document.getElementById('error-message').textContent = 'Network error. Please try again.';
            document.getElementById('error-message').style.display = 'block';
        }
    });
</script>
{% endblock %}
